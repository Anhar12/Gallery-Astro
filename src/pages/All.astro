---
// File: src/pages/All.astro
import Template from "./Template.astro";
import { supabase } from "../lib/supabase";

const { data: images, error } = await supabase
  .from("Gallery")
  .select("id, name, url")
  .order("id", { ascending: false });
---

<Template title="All Gallery" section="All">
  <div class="relative min-h-screen py-20 md:px-12 md:space-y-6 space-y-2">
    <form id="search-mob" method="GET" action='' class="flex w-full text-white font-light text-sm group md:hidden px-4" autocomplete="off">
      <input type="text" id="search-mobile" name="search-mobile" class="w-full h-6 px-1 border-b-[1px] border-transparent focus:border-white outline-none transition-all duration-300" placeholder="Cari Gambar">
      <button id="submit-search-mobile" type="submit" class="px-3 cursor-pointer hover:scale-110 transition-all duration-300 text-slate-400 hover:text-white group-focus-within:text-white">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
    </form>

    {error && (
      <p class="text-red-500 text-center mb-4">Gagal memuat gambar: {error.message}</p>
    )}

    <div
      id="not-found"
      class="text-center text-gray-400 hidden"
    >
      Tidak ada gambar yang ditemukan.
    </div>

    <div class="gallery-masonry">
      {images.map((img) => (
        <div class="gallery-item cursor-pointer hover:shadow-[0_0_10px_rgba(115,212,255,0.3)] transition-shadow duration-300 shadow-sky-200 p-2" key={img.id} data-name={img.name} data-url={img.url} data-date={new Date(img.created_date).toLocaleDateString()}>
          <img src={img.url} alt={img.name} />
          <p class="caption">{img.name}</p>
        </div>
      ))}
    </div>
  </div>
  <div id="detail" class="w-full h-screen relative top-0 left-0 z-40 hidden cursor-pointer">
    <div id="detail-body" class="p-3 w-[90%] md:w-auto bg-white rounded-md fixed transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 flex justify-center items-center flex-col z-10">
      <p id="detail-name" class="text-black text-sm font-semibold md:text-lg text-center pb-2"></p>
      <img id="detail-image" class="md:h-[80vh]" src="" alt="" />
    </div>
    <div class="w-full h-screen bg-black/50 fixed transform -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2 z-0"></div>
  </div>
</Template>

<script>
  let search = $('#search').val();

  function searchActive() {
    $('#search-nav #search')
      .addClass('border-white')
      .removeClass('border-transparent');
    $('#search-mob #search-mobile')
      .addClass('border-white')
      .removeClass('border-transparent');

    $('#search-nav #submit-search')
      .addClass('text-white scale-110')
      .removeClass('text-slate-400');
    $('#search-mob #submit-search-mobile')
      .addClass('text-white scale-110')
      .removeClass('text-slate-400');
  }

  function searchInactive() {
    $('#search-nav #search')
      .addClass('border-transparent')
      .removeClass('border-white');
    $('#search-mob #search-mobile')
      .addClass('border-transparent')
      .removeClass('border-white');
    
    $('#search-nav #submit-search')
      .addClass('text-slate-400')
      .removeClass('text-white scale-110');
    $('#search-mob #submit-search-mobile')
      .addClass('text-slate-400')
      .removeClass('text-white scale-110');
  }

  if (search) {
    searchActive();
  } else {
    searchInactive();
  }

  $('#search, #search-mobile').on('change', function () {
    $('#search').val($(this).val());
    $('#search-mobile').val($(this).val());
    if ($(this).val()) {
      searchActive();
    } else {
      searchInactive();
    }
  });

  $('#search-nav, #search-mob').on('submit', function (e) {
    e.preventDefault();
    const keyword = $('#search').val().toLowerCase().trim();
    filterGallery(keyword);
  });

  $('#search, #search-mobile').on('input', function () {
    const keyword = $(this).val().toLowerCase().trim();
    filterGallery(keyword);
  });

  function filterGallery(keyword) {
    let found = false;

    $('.gallery-item').each(function () {
      const name = $(this).data('name').toLowerCase();
      if (name.includes(keyword)) {
        $(this).show();
        found = true;
      } else {
        $(this).hide();
      }
    });

    if (found) {
      $('#not-found').hide();
    } else {
      $('#not-found').show();
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  const searchQuery = urlParams.get('search');
  if (searchQuery) {
    $('#search').val(searchQuery);
    $('#search-mobile').val(searchQuery);
    filterGallery(searchQuery.toLowerCase().trim());
  }

  function openDetail() {
    $('#detail')
      .addClass('flex')
      .removeClass('hidden');

    $('#detail-body')
      .removeClass('modal-close')
      .addClass('modal-open');
  }

  function closeDetail() {
    setTimeout(() => {
      $('#detail')
        .removeClass('flex')
        .addClass('hidden');
    }, 200);
    
    $('#detail-body')
      .removeClass('modal-open')
      .addClass('modal-close');
  }

  $('#detail').click(function () {
    closeDetail();
  });
  
  $('.gallery-item').click(function () {
    const name = $(this).data('name');
    const url = $(this).data('url');

    $('#detail-image').attr('src', url);
    $('#detail-image').attr('alt', name);
    $('#detail-name').text(name);

    openDetail();
  });
</script>
