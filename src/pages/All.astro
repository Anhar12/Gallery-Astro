---
// File: src/pages/All.astro
import Template from "./Template.astro";
import { supabase } from "../lib/supabase";

const { data: images, error } = await supabase
  .from("Gallery")
  .select("id, name, url")
  .order("id", { ascending: false });
---

<Template title="All Gallery" section="All">
  <div class="relative min-h-screen py-20 px-12 space-y-6">

    {error && (
      <p class="text-red-500 text-center mb-4">Gagal memuat gambar: {error.message}</p>
    )}

    <div
      id="not-found"
      class="text-center text-gray-400 hidden"
    >
      Tidak ada gambar yang ditemukan.
    </div>

    <div class="gallery-masonry">
      {images.map((img) => (
        <div class="gallery-item cursor-pointer hover:shadow-[0_0_10px_rgba(115,212,255,0.3)] transition-shadow duration-300 shadow-sky-200 p-2" key={img.id} data-name={img.name}>
          <img src={img.url} alt={img.name} />
          <p class="caption">{img.name}</p>
        </div>
      ))}
    </div>
  </div>
</Template>

<script>
  $('#search-nav').on('submit', function (e) {
    e.preventDefault();
    const keyword = $('#search').val().toLowerCase().trim();
    filterGallery(keyword);
  });

  $('#search').on('input', function () {
    const keyword = $(this).val().toLowerCase().trim();
    filterGallery(keyword);
  });

  function filterGallery(keyword) {
    let found = false;

    $('.gallery-item').each(function () {
      const name = $(this).data('name').toLowerCase();
      if (name.includes(keyword)) {
        $(this).show();
        found = true;
      } else {
        $(this).hide();
      }
    });

    if (found) {
      $('#not-found').hide();
    } else {
      $('#not-found').show();
    }
  }

  const urlParams = new URLSearchParams(window.location.search);
  const searchQuery = urlParams.get('search');
  if (searchQuery) {
    $('#search').val(searchQuery);
    filterGallery(searchQuery.toLowerCase().trim());
  }
</script>
